<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æµ£ç†Šçš„èŠ±æè³‡æ–™åº« v3.0.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');
        
        :root {
            /* v3.0 é…è‰²ï¼šç¶­æŒæ·±æš–è‰²ç³»ï¼Œå¢å¼·è³‡æ–™é–±è®€æ€§ */
            --bg-color: #26201E;       
            --card-color: #362B28;     
            --input-bg: rgba(0, 0, 0, 0.3);
            --text-main: #EFE5D5;      
            --text-sub: #A89088;       
            --accent: #FFAB5E;         
            --accent-hover: #D48438;
            --nav-height: 70px;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* === éŸ¿æ‡‰å¼ä½ˆå±€æ ¸å¿ƒ === */
        #app-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            width: 100%;
            /* é è¨­æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
        }

        /* æ‰‹æ©Ÿç‰ˆ View åˆ‡æ› */
        .page-view {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            padding-bottom: calc(var(--nav-height) + 1rem); /* é¿é–‹åº•éƒ¨å°è¦½ */
        }

        .page-view.active {
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }

        /* ç­†é›»/æ¡Œæ©Ÿç‰ˆ (Desktop) æ¨£å¼è¦†å¯« */
        @media (min-width: 768px) {
            body {
                padding: 20px; /* æ¡Œæ©Ÿç‰ˆç•™é»é‚Šè·æ¯”è¼ƒå¥½çœ‹ */
            }
            
            #app-container {
                display: flex; /* æ”¹ç‚ºå·¦å³æ’åˆ— */
                flex-direction: row;
                gap: 20px;
                max-width: 1200px;
                margin: 0 auto;
                height: 100%;
                overflow: hidden;
            }

            /* åœ¨æ¡Œæ©Ÿç‰ˆå¼·åˆ¶é¡¯ç¤ºæ‰€æœ‰ Viewï¼Œå–æ¶ˆçµ•å°å®šä½ */
            .page-view {
                position: relative;
                opacity: 1 !important;
                visibility: visible !important;
                padding: 0;
                height: 100%;
                overflow: hidden;
            }

            /* å·¦å´å±•ç¤ºå€ */
            #view-shop {
                flex: 1;
                border-right: 1px solid rgba(255,255,255,0.1);
                padding-right: 20px;
                justify-content: center;
            }

            /* å³å´è³‡æ–™åº«å€ */
            #view-diary {
                flex: 1;
                padding-left: 0;
            }

            /* éš±è—åº•éƒ¨å°è¦½åˆ— */
            .bottom-nav {
                display: none !important;
            }

            /* éš±è—æ¼¢å ¡é¸å–®ç‰ˆæœ¬è™Ÿï¼Œæ”¹é¡¯ç¤ºåœ¨è§’è½ */
            .version-tag {
                top: 20px;
                left: 20px;
            }
        }

        /* Canvas å®¹å™¨ */
        #canvas-wrapper {
            position: relative;
            width: 100%;
            /* æ‰‹æ©Ÿç‰ˆé™åˆ¶å¯¬åº¦ï¼Œæ¡Œæ©Ÿç‰ˆè‡ªé©æ‡‰ */
            max-width: 100%; 
            aspect-ratio: 4/3; 
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 4px solid var(--card-color);
            background-color: #1a1a1a;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* åº•éƒ¨å°è¦½åˆ— (åƒ…æ‰‹æ©Ÿé¡¯ç¤º) */
        .bottom-nav {
            height: var(--nav-height);
            background-color: var(--card-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            z-index: 50;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .nav-btn {
            color: var(--text-sub);
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            width: 50%;
            height: 100%;
            justify-content: center;
            border: none;
            background: transparent;
        }
        .nav-btn.active { color: var(--accent); }

        /* è¼¸å…¥å…ƒä»¶é€šç”¨æ¨£å¼ */
        .custom-input, .custom-select {
            background-color: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            transition: all 0.3s;
        }
        .custom-input:focus, .custom-select:focus {
            border-color: var(--accent);
            background-color: rgba(0, 0, 0, 0.4);
            outline: none;
        }

        /* æœå°‹æ¡† */
        .search-box {
            position: relative;
            margin-bottom: 10px;
        }
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-sub);
            font-size: 0.8rem;
        }
        .search-box input {
            width: 100%;
            padding: 8px 10px 8px 32px;
            border-radius: 20px;
            font-size: 0.9rem;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            color: var(--text-main);
        }

        /* ç‰ˆæœ¬è™Ÿ */
        .version-tag {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.6rem;
            color: var(--text-sub);
            opacity: 0.5;
            font-family: monospace;
            z-index: 50;
        }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #55443F; border-radius: 3px; }

        /* ç¼ºåœ–æç¤ºæ¡† */
        #missing-assets-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--accent);
            padding: 20px;
            border-radius: 12px;
            z-index: 100;
            text-align: center;
            max-width: 90%;
            display: none;
        }
    </style>
</head>
<body>

    <div class="version-tag">ver 3.0.0 (Database)</div>

    <!-- é ‚éƒ¨æ¨™é¡Œ (æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºï¼Œæ¡Œæ©Ÿç‰ˆå¯é¸) -->
    <header class="text-center pt-4 pb-2 bg-[#26201E] z-20 shrink-0 md:hidden">
        <h1 class="text-lg font-bold tracking-wider text-[#EFE5D5]">
            <i class="fas fa-database mr-2 text-[#FFAB5E]"></i>èŠ±æè³‡æ–™åº«
        </h1>
    </header>

    <!-- App Container (é›™æ¨¡çµ„ä½ˆå±€) -->
    <div id="app-container">
        
        <!-- ç¼ºåœ–æç¤º -->
        <div id="missing-assets-alert">
            <h3 class="text-[#EFE5D5] font-bold mb-2">å•Ÿç”¨é è¦½æ¨¡å¼</h3>
            <p class="text-[#A89088] text-xs mb-3">åµæ¸¬åˆ°åœ–ç‰‡æª”ç¼ºæ¼ï¼Œå°‡ä½¿ç”¨è‰²å¡Šä»£æ›¿èƒŒæ™¯ã€‚</p>
            <div id="missing-list-content" class="text-left text-[10px] bg-white/10 p-2 rounded mb-3 text-[#FFAB5E] font-mono"></div>
            <button onclick="document.getElementById('missing-assets-alert').style.display='none'" 
                class="bg-[#FFAB5E] text-[#26201E] px-4 py-1.5 rounded font-bold text-xs hover:bg-[#D48438]">
                ç¢ºèª
            </button>
        </div>

        <!-- === å·¦å´/åˆ†é  1: èŠ±åº—å±•ç¤º (VISUALIZER) === -->
        <div id="view-shop" class="page-view active">
            
            <h2 class="hidden md:block text-xl font-bold text-[#EFE5D5] mb-4 text-center">
                <i class="fas fa-store mr-2 text-[#FFAB5E]"></i>åº—èˆ–å±•ç¤º
            </h2>

            <!-- è³‡è¨Šæ¢ -->
            <div class="w-full flex justify-between items-center mb-4 px-1 md:max-w-full">
                <button id="debug-btn" class="bg-[#362B28] text-[#A89088] px-3 py-1.5 rounded-lg text-xs border border-white/5 hover:text-white transition-colors">
                    <i class="fas fa-wrench mr-1"></i>æ ¡æ­£
                </button>
                <div class="flex gap-2">
                    <div class="bg-[#362B28] text-[#FFAB5E] px-3 py-1.5 rounded-lg text-xs border border-white/5 font-bold">
                        <i class="fas fa-layer-group mr-1"></i><span id="stage-display">Level 0</span>
                    </div>
                    <div class="bg-[#362B28] text-[#88C999] px-3 py-1.5 rounded-lg text-xs border border-white/5 font-bold" title="è³‡æ–™ç¸½ç­†æ•¸">
                        <i class="fas fa-database mr-1"></i><span id="total-count-display">0</span>
                    </div>
                </div>
            </div>

            <!-- Canvas -->
            <div id="canvas-wrapper">
                <div id="loading-overlay" class="absolute inset-0 bg-[#26201E] z-20 flex flex-col items-center justify-center text-[#A89088]">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-[#FFAB5E]"></i>
                    <p class="text-xs">Loading Database Visuals...</p>
                </div>
                <canvas id="gameCanvas"></canvas>
                
                <!-- æµ£ç†Š -->
                <div id="raccoon-area" class="absolute bottom-[5%] right-[5%] w-[15%] h-[20%] z-20 cursor-pointer rounded-full"></div>
                <div id="raccoon-speech" class="absolute bottom-[25%] right-[10%] bg-white text-[#362B28] px-3 py-2 rounded-xl text-xs font-bold shadow-lg border-2 border-[#FFAB5E] pointer-events-none opacity-0 transition-opacity z-30 whitespace-nowrap">
                    æ­¡è¿ï¼
                </div>
            </div>
            
            <div id="debug-info" class="mt-4 text-[10px] text-[#FFAB5E] font-mono hidden bg-black/50 px-2 py-1 rounded w-full text-center"></div>
        </div>

        <!-- === å³å´/åˆ†é  2: è³‡æ–™åº«æ“ä½œ (DATABASE) === -->
        <div id="view-diary" class="page-view">
            
            <h2 class="hidden md:block text-xl font-bold text-[#EFE5D5] mb-4 text-center">
                <i class="fas fa-database mr-2 text-[#FFAB5E]"></i>èŠ±æè³‡æ–™åº«
            </h2>

            <div class="w-full flex flex-col gap-4 h-full md:max-w-full">
                
                <!-- 1. æ–°å¢è¼¸å…¥å€ -->
                <div class="bg-[#362B28] p-5 rounded-2xl shadow-lg border border-white/5 shrink-0">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-[#FFAB5E] flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i> æ–°å¢èŠ±æè³‡æ–™
                        </h3>
                        <button id="mic-btn" class="w-7 h-7 rounded-full bg-[#26201E] text-[#A89088] hover:text-[#FFAB5E] flex items-center justify-center transition-colors">
                            <i class="fas fa-microphone text-xs"></i>
                        </button>
                    </div>

                    <div class="space-y-3">
                        <!-- èŠ±å -->
                        <div class="relative group">
                            <i class="fas fa-tag absolute left-3 top-3 text-[#A89088] text-xs group-focus-within:text-[#FFAB5E] transition-colors"></i>
                            <input type="text" id="input-name" placeholder="èŠ±å‰åç¨± (ä¾‹å¦‚: å°¤åŠ åˆ©è‘‰)" 
                                class="custom-input w-full pl-8 pr-3 py-2.5 rounded-xl text-sm">
                        </div>
                        
                        <!-- æ•¸é‡ã€å–®ä½ã€å–®åƒ¹ (Grid Layout) -->
                        <div class="grid grid-cols-3 gap-2">
                            <!-- æ•¸é‡ -->
                            <div class="relative">
                                <input type="number" id="input-qty" placeholder="æ•¸é‡" 
                                    class="custom-input w-full px-3 py-2.5 rounded-xl text-sm text-center">
                            </div>
                            <!-- å–®ä½é¸æ“‡ (æ–°åŠŸèƒ½) -->
                            <div class="relative">
                                <select id="input-unit" class="custom-select w-full px-2 py-2.5 rounded-xl text-sm text-center appearance-none cursor-pointer">
                                    <option value="æŠŠ">æŠŠ</option>
                                    <option value="æ”¯">æ”¯</option>
                                    <option value="ç‰‡">ç‰‡</option>
                                    <option value="ç›†">ç›†</option>
                                    <option value="æŸ">æŸ</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-2 top-3 text-[10px] text-[#A89088] pointer-events-none"></i>
                            </div>
                            <!-- åƒ¹æ ¼ -->
                            <div class="relative">
                                <i class="fas fa-dollar-sign absolute left-2 top-3 text-[#A89088] text-xs"></i>
                                <input type="number" id="input-price" placeholder="å–®åƒ¹" 
                                    class="custom-input w-full pl-5 pr-2 py-2.5 rounded-xl text-sm text-right">
                            </div>
                        </div>

                        <button id="add-btn" class="w-full bg-gradient-to-r from-[#FFAB5E] to-[#D48438] text-white font-bold py-2.5 rounded-xl shadow-lg active:scale-[0.98] transition-all text-sm mt-1 hover:shadow-orange-500/20">
                            å¯«å…¥è³‡æ–™åº«
                        </button>
                    </div>
                </div>

                <!-- 2. è³‡æ–™åˆ—è¡¨å€ -->
                <div class="bg-[#362B28] rounded-2xl shadow-lg border border-white/5 flex-1 overflow-hidden flex flex-col min-h-0 relative">
                    
                    <!-- æœå°‹åˆ— (å›ºå®šåœ¨å¡ç‰‡é ‚éƒ¨) -->
                    <div class="p-3 border-b border-white/5 bg-[#26201E]/50 shrink-0">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-input" placeholder="æœå°‹æ­·å²ç´€éŒ„...">
                        </div>
                        <div class="flex justify-between items-end px-1">
                            <span class="text-[10px] text-[#A89088]">æ­·å²æ¸…å–®</span>
                            <span id="filtered-count" class="text-[10px] bg-[#FFAB5E]/10 text-[#FFAB5E] px-2 py-0.5 rounded">0 ç­†</span>
                        </div>
                    </div>
                    
                    <!-- åˆ—è¡¨æ²å‹•å€ -->
                    <ul id="item-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <!-- JS ç”¢ç”Ÿé …ç›® -->
                    </ul>

                    <!-- ç©ºç‹€æ…‹ -->
                    <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-[#A89088] opacity-40 absolute inset-0 pointer-events-none">
                        <i class="fas fa-folder-open text-4xl mb-2"></i>
                        <p class="text-xs">è³‡æ–™åº«æ˜¯ç©ºçš„</p>
                    </div>
                </div>

                <!-- è³‡æ–™ç®¡ç† -->
                <div class="text-center py-1 shrink-0 flex justify-center gap-4">
                    <button onclick="exportData()" class="text-[10px] text-[#A89088] hover:text-[#EFE5D5] transition-colors" title="Console Log JSON">
                        <i class="fas fa-file-export mr-1"></i>å‚™ä»½(Log)
                    </button>
                    <button onclick="clearData()" class="text-[10px] text-[#A89088] hover:text-red-400 transition-colors">
                        <i class="fas fa-trash-alt mr-1"></i>æ¸…ç©ºè³‡æ–™åº«
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°è¦½ (åƒ…æ‰‹æ©Ÿç‰ˆ) -->
    <nav class="bottom-nav md:hidden">
        <button class="nav-btn active" onclick="switchTab('shop')">
            <i class="fas fa-store-alt mb-1"></i>
            <span class="text-[10px]">å±•ç¤º</span>
        </button>
        <button class="nav-btn" onclick="switchTab('diary')">
            <i class="fas fa-database mb-1"></i>
            <span class="text-[10px]">è³‡æ–™åº«</span>
        </button>
    </nav>

    <!-- ç¨‹å¼é‚è¼¯ -->
    <script>
        // ==========================================
        // 1. è¨­å®šèˆ‡ç‰ˆæœ¬ (Config & Version)
        // ==========================================
        const VERSION = "v3.0.0";
        console.log(`System Initialized: ${VERSION}`);

        // éšæ®µåœ–æª”è¨­å®š (è‹¥ç„¡åœ–æœƒè‡ªå‹•åˆ‡æ›é è¦½æ¨¡å¼)
        const STAGES = [
            { threshold: 0,  file: 'shop_stage_0.png', name: "ç©ºæ› ç©ºé–“", color: "#3C302C" }, 
            { threshold: 3,  file: 'shop_stage_1.png', name: "åˆç´šå·¥ä½œå®¤", color: "#6D5B4F" }, 
            { threshold: 10, file: 'shop_stage_2.png', name: "ä¸­ç´šèŠ±åŠ", color: "#4E6E5D" }, 
            { threshold: 20, file: 'shop_stage_3.png', name: "é«˜ç´šååº—", color: "#D48438" }  
        ];

        // æ­éœ²é»åº§æ¨™ (è¦–è¦ºåŒ–ç”¨)
        const REVEAL_POSITIONS = [
            { x: 150, y: 320, r: 60 }, { x: 300, y: 280, r: 55 },
            { x: 450, y: 350, r: 65 }, { x: 650, y: 300, r: 60 },
            { x: 200, y: 450, r: 50 }, { x: 400, y: 200, r: 40 },
            { x: 550, y: 450, r: 55 }, { x: 100, y: 200, r: 45 },
            { x: 700, y: 400, r: 50 }, { x: 350, y: 500, r: 60 }
        ];

        // ==========================================
        // 2. è³‡æ–™çµæ§‹èˆ‡ç‹€æ…‹ (State)
        // ==========================================
        // v3.0 è³‡æ–™çµæ§‹æ›´æ–°ï¼šitems ä»ç‚ºé™£åˆ—ï¼Œä½†è¦–ç‚ºè³‡æ–™åº«æ¢ç›®
        // ç‚ºäº†ç›¸å®¹æ€§ï¼Œæª¢æŸ¥ localStorage Keyï¼Œè‹¥ç„¡å‰‡å»ºç«‹
        let items = JSON.parse(localStorage.getItem('raccoon_db_v3_items')) || [];
        
        let loadedImages = {};
        let missingFiles = [];
        let isAssetsReady = false;
        let isDebugMode = false;
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-wrapper');

        // ==========================================
        // 3. è³‡ç”¢è¼‰å…¥ (Asset Loader)
        // ==========================================
        async function loadAssets() {
            const promises = STAGES.map(stage => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = stage.file;
                    img.onload = () => resolve({ file: stage.file, img: img, status: 'ok' });
                    img.onerror = () => resolve({ file: stage.file, img: null, status: 'missing' }); 
                });
            });

            const results = await Promise.all(promises);
            results.forEach(res => {
                loadedImages[res.file] = res.img;
                if (res.status === 'missing') missingFiles.push(res.file);
            });

            // åˆå§‹åŒ– Canvas å°ºå¯¸
            const baseImg = loadedImages[STAGES[0].file];
            if (baseImg) {
                canvas.width = baseImg.naturalWidth;
                canvas.height = baseImg.naturalHeight;
            } else {
                canvas.width = 800;
                canvas.height = 600; // é è¨­å€¼
            }
            // é€é CSS ä¿æŒæ¯”ä¾‹
            container.style.aspectRatio = `${canvas.width}/${canvas.height}`;

            isAssetsReady = true;
            document.getElementById('loading-overlay').style.display = 'none';

            if (missingFiles.length > 0) {
                const listHtml = missingFiles.map(f => `â€¢ ${f}`).join('<br>');
                document.getElementById('missing-list-content').innerHTML = listHtml;
                document.getElementById('missing-assets-alert').style.display = 'block';
            }

            drawScene();
        }

        // ==========================================
        // 4. ç¹ªåœ–èˆ‡è¦–è¦ºåŒ– (Visualizer)
        // ==========================================
        function drawScene() {
            if (!isAssetsReady) return;

            const count = items.length;
            
            // è¨ˆç®—ç›®å‰ç­‰ç´š (Stage)
            let currentStageIdx = 0;
            for (let i = STAGES.length - 1; i >= 0; i--) {
                if (count >= STAGES[i].threshold) {
                    currentStageIdx = i;
                    break;
                }
            }
            
            const currentStage = STAGES[currentStageIdx];
            const nextStage = STAGES[currentStageIdx + 1];

            document.getElementById('stage-display').textContent = currentStage.name;
            document.getElementById('total-count-display').textContent = count;

            // ç¹ªè£½èƒŒæ™¯å±¤
            const bgImg = loadedImages[currentStage.file];
            if (bgImg) {
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = currentStage.color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // ç¼ºåœ–æ™‚çš„æ–‡å­—è£é£¾
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.font = "bold 60px Zen Maru Gothic";
                ctx.textAlign = "center";
                ctx.fillText(currentStage.name, canvas.width/2, canvas.height/2);
            }

            // ç¹ªè£½æ­éœ²å±¤ (é è¦½ä¸‹ä¸€ç´š)
            if (nextStage) {
                ctx.save();
                ctx.beginPath();
                
                // åœ“é»æ•¸é‡é‚è¼¯ï¼šè¶Šå¤šè³‡æ–™ï¼Œæ­éœ²è¶Šå¤š
                const circlesToDraw = isDebugMode ? REVEAL_POSITIONS.length : count;
                
                for(let i = 0; i < circlesToDraw; i++) {
                    const pos = REVEAL_POSITIONS[i % REVEAL_POSITIONS.length];
                    ctx.moveTo(pos.x + pos.r, pos.y);
                    ctx.arc(pos.x, pos.y, pos.r, 0, Math.PI * 2);
                }
                
                ctx.clip(); // é®ç½©ç”Ÿæ•ˆ

                const fgImg = loadedImages[nextStage.file];
                if (fgImg) {
                    ctx.drawImage(fgImg, 0, 0, canvas.width, canvas.height);
                } else {
                    ctx.fillStyle = nextStage.color;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                ctx.restore();
            }

            // Debug è¼”åŠ©ç·š
            if (isDebugMode) {
                ctx.strokeStyle = '#FFAB5E';
                ctx.lineWidth = 3;
                REVEAL_POSITIONS.forEach((pos, idx) => {
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, pos.r, 0, Math.PI * 2);
                    ctx.stroke();
                });
            }
        }

        // ==========================================
        // 5. è³‡æ–™åº«é‚è¼¯ (Database Logic)
        // ==========================================
        const itemListEl = document.getElementById('item-list');
        const emptyStateEl = document.getElementById('empty-state');
        const searchInput = document.getElementById('search-input');

        // æ¸²æŸ“åˆ—è¡¨ (æ”¯æ´ç¯©é¸)
        function renderList(filterText = '') {
            itemListEl.innerHTML = '';
            
            // ç¯©é¸é‚è¼¯
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(filterText.toLowerCase())
            );

            document.getElementById('filtered-count').textContent = `${filteredItems.length} ç­†`;

            if (items.length === 0) {
                emptyStateEl.style.display = 'flex';
                return;
            } else {
                emptyStateEl.style.display = 'none';
            }

            // åè½‰é †åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
            [...filteredItems].reverse().forEach((item, index) => {
                const totalCost = parseInt(item.price) * parseInt(item.qty);
                const dateObj = new Date(item.date);
                const dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()}`; // ç°¡å–®æ—¥æœŸ

                const li = document.createElement('li');
                li.className = 'bg-[#26201E] p-3 rounded-xl border border-white/5 flex justify-between items-center group hover:bg-[#3E322E] transition-colors';
                
                li.innerHTML = `
                    <div class="flex flex-col">
                        <div class="text-[#EFE5D5] font-bold text-sm flex items-center gap-2">
                            <span>${item.name}</span>
                            <span class="text-[10px] text-[#A89088] bg-black/20 px-1.5 rounded">${dateStr}</span>
                        </div>
                        <div class="text-[11px] text-[#A89088] mt-0.5">
                            å–®åƒ¹ $${item.price} / ${item.unit}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[#FFAB5E] font-bold text-sm">$${totalCost.toLocaleString()}</div>
                        <div class="text-[10px] text-[#A89088]">Ã— ${item.qty} ${item.unit}</div>
                    </div>
                `;
                
                // é»æ“Šé …ç›®è‡ªå‹•å¸¶å…¥æœå°‹ (æ–¹ä¾¿æŸ¥çœ‹è©²èŠ±æ­·å²)
                li.addEventListener('click', () => {
                    searchInput.value = item.name;
                    renderList(item.name);
                });

                itemListEl.appendChild(li);
            });
        }

        // æ–°å¢è³‡æ–™
        document.getElementById('add-btn').addEventListener('click', () => {
            const name = document.getElementById('input-name').value.trim();
            const qty = document.getElementById('input-qty').value.trim();
            const unit = document.getElementById('input-unit').value; // å–å¾—å–®ä½
            const price = document.getElementById('input-price').value.trim();

            if (!name || !qty || !price) {
                showSpeech("è³‡æ–™ä¸å®Œæ•´å–”ï¼");
                return;
            }

            const newItem = { 
                name, 
                qty: parseInt(qty), 
                unit,
                price: parseInt(price),
                date: new Date().toISOString()
            };

            items.push(newItem);
            localStorage.setItem('raccoon_db_v3_items', JSON.stringify(items)); // v3 Key
            
            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('input-name').value = '';
            document.getElementById('input-qty').value = '';
            document.getElementById('input-price').value = '';
            
            // æª¢æŸ¥æ˜¯å¦å‡ç´š
            checkUpgrade(items.length - 1, items.length);

            renderList(searchInput.value); // ä¿æŒç›®å‰çš„æœå°‹ç‹€æ…‹
            drawScene();
            showSpeech("è³‡æ–™åº«å¯«å…¥æˆåŠŸï¼");
        });

        // å‡ç´šæª¢æŸ¥
        function checkUpgrade(prevCount, newCount) {
            const upgradeStage = STAGES.find(s => s.threshold > prevCount && s.threshold <= newCount);
            if (upgradeStage) {
                alert(`ğŸ‰ è³‡æ–™åº«æ“´å……ï¼\nå ´æ™¯å‡ç´šç‚ºï¼šã€Œ${upgradeStage.name}ã€`);
            }
        }

        // æœå°‹ç›£è½
        searchInput.addEventListener('input', (e) => {
            renderList(e.target.value);
        });

        // æ¸…ç©ºè³‡æ–™
        function clearData() {
            if(confirm("è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºæ‰€æœ‰æ­·å²è³‡æ–™åº«ï¼\nç¢ºå®šåŸ·è¡Œå—ï¼Ÿ")) {
                items = [];
                localStorage.removeItem('raccoon_db_v3_items');
                renderList();
                drawScene();
                showSpeech("è³‡æ–™åº«å·²é‡ç½®");
            }
        }
        
        // åŒ¯å‡ºè³‡æ–™ (Console)
        function exportData() {
            console.log(JSON.stringify(items, null, 2));
            alert("è³‡æ–™å·²è¼¸å‡ºè‡³ Console (F12)ï¼Œå¯è¤‡è£½å‚™ä»½ JSONã€‚");
        }

        // ==========================================
        // 6. UI äº’å‹•èˆ‡å·¥å…·
        // ==========================================
        
        // åˆ†é åˆ‡æ› (åƒ…æ‰‹æ©Ÿç‰ˆæœ‰æ•ˆ)
        window.switchTab = function(tabName) {
            // æ‰‹æ©Ÿç‰ˆåˆ‡æ›é‚è¼¯
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const idx = tabName === 'shop' ? 0 : 1;
            document.querySelectorAll('.nav-btn')[idx].classList.add('active');

            // é‡å°æ‰‹æ©Ÿç‰ˆåš visibility åˆ‡æ›ï¼Œæ¡Œæ©Ÿç‰ˆç”± CSS è™•ç†å¼·åˆ¶é¡¯ç¤º
            if (window.innerWidth < 768) {
                document.querySelectorAll('.page-view').forEach(view => {
                    view.classList.remove('active');
                    view.style.visibility = 'hidden'; 
                });
                const target = document.getElementById(`view-${tabName}`);
                target.style.visibility = 'visible';
                target.classList.add('active');
            }
        }

        // è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡ç¹ª (ç¢ºä¿ RWD Canvas æ­£ç¢º)
        window.addEventListener('resize', () => {
            drawScene();
            // é‡ç½® tab é¡¯ç¤ºç‹€æ…‹ä»¥é˜² CSS è¡çª
            if (window.innerWidth >= 768) {
                document.querySelectorAll('.page-view').forEach(v => {
                    v.style.visibility = 'visible';
                    v.classList.add('active');
                });
            } else {
                switchTab('shop'); // æ‰‹æ©Ÿç‰ˆå›åˆ°é è¨­é 
            }
        });

        // Debug æ¨¡å¼
        document.getElementById('debug-btn').addEventListener('click', () => {
            isDebugMode = !isDebugMode;
            const info = document.getElementById('debug-info');
            const btn = document.getElementById('debug-btn');
            
            if (isDebugMode) {
                info.classList.remove('hidden');
                btn.style.color = '#FFAB5E';
                btn.style.borderColor = '#FFAB5E';
                canvas.style.cursor = 'crosshair';
                showSpeech("Debug æ¨¡å¼é–‹å•Ÿ");
            } else {
                info.classList.add('hidden');
                btn.style.color = '#A89088';
                btn.style.borderColor = 'rgba(255,255,255,0.05)';
                canvas.style.cursor = 'default';
            }
            drawScene();
        });

        canvas.addEventListener('click', (e) => {
            if (!isDebugMode) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            const code = `{ x: ${x}, y: ${y}, r: 50 },`;
            document.getElementById('debug-info').textContent = `Copied: ${code}`;
            navigator.clipboard.writeText(code);
            
            REVEAL_POSITIONS.push({ x, y, r: 50 });
            drawScene();
        });

        // èªéŸ³è¼¸å…¥
        document.getElementById('mic-btn').addEventListener('click', () => {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.onstart = () => showSpeech("æˆ‘åœ¨è½...");
                recognition.onresult = (e) => {
                    document.getElementById('input-name').value = e.results[0][0].transcript;
                };
                recognition.start();
            } else {
                showSpeech("ä¸æ”¯æ´èªéŸ³è¼¸å…¥ QQ");
            }
        });

        // æµ£ç†Šèªªè©±
        const speechEl = document.getElementById('raccoon-speech');
        let speechTimer;
        function showSpeech(text) {
            speechEl.textContent = text;
            speechEl.style.opacity = '1';
            clearTimeout(speechTimer);
            speechTimer = setTimeout(() => speechEl.style.opacity = '0', 2500);
        }
        document.getElementById('raccoon-area').addEventListener('click', () => {
            const msgs = ["è¦æŸ¥è©¢æ­·å²åƒ¹æ ¼å—ï¼Ÿ", "è¨˜å¾—é¸å°å–®ä½å–”ï¼", "ä»Šå¤©èŠ±æçœŸæ–°é®®", "è³‡æ–™åº«è¶Šä¾†è¶Šè±å¯Œäº†"];
            showSpeech(msgs[Math.floor(Math.random() * msgs.length)]);
        });

        // åˆå§‹åŒ–
        loadAssets();
        renderList();
        
        // åˆå§‹ Layout åˆ¤æ–·
        if (window.innerWidth < 768) {
            switchTab('shop');
        }

    </script>
</body>
</html>
